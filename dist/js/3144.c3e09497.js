"use strict";(self["webpackChunkorange"]=self["webpackChunkorange"]||[]).push([[1066,3144],{43144:function(e,a,l){l.r(a),l.d(a,{default:function(){return R}});var n=l(25136),r=(l(97042),l(69957),l(21929)),o=(l(98421),l(65451)),t=(l(63390),l(12687)),s=(l(31112),l(85415)),i=(l(22243),l(7409),l(76408)),d=(l(87535),l(32465),l(14022)),u=(l(72343),l(18111),l(22489),l(56768)),p=l(90144),y=l(45130),m=l(24232),g=l(26695),c=l(36525),f=l(21016),T=l(36947),O=l(46509),b=l(71066),v=l(82572);const F={class:"form-single-fragment third-party-dlg",style:{position:"relative"}};var S=(0,u.pM)({__name:"editOnlineForm",props:{pageId:{},pageType:{},datasourceTableList:{},datasourceId:{},form:{},dialog:{},thirdParamsString:{},dialogKey:{}},setup(e){const a=(0,v.l5)(),l=e,{getFormConfig:S}=(0,O.U)(),{thirdParams:_,onCloseThirdDialog:R}=(0,b.P)(l),k=(0,u.EW)(()=>a.defaultFormItemSize||_.value.defaultFormItemSize?.value),h=(0,p.KR)({formId:void 0,formCode:void 0,formName:void 0,formKind:c.SysOnlineFormKind.PAGE,formType:void 0,masterTableId:void 0,widgetJson:void 0}),E={formCode:[{required:!0,message:"表单编码不能为空",trigger:"blur"},{type:"string",pattern:/^[A-Za-z0-9]+$/,message:"表单编码只允许输入字母和数字",trigger:"blur"}],formName:[{required:!0,message:"表单名称不能为空",trigger:"blur"}],masterTableId:[{required:!0,message:"请选择表单数据",trigger:"blur"}]},N=(0,u.EW)(()=>f.SysOnlineFormType.getList().filter(e=>e.id===f.SysOnlineFormType.FLOW?w.value.pageType===c.SysOnlinePageType.FLOW:e.id===f.SysOnlineFormType.QUERY||e.id===f.SysOnlineFormType.ADVANCE_QUERY||e.id===f.SysOnlineFormType.GROUP_QUERY?w.value.pageType!==c.SysOnlinePageType.FLOW:e.id===f.SysOnlineFormType.WORK_ORDER?w.value.pageType===c.SysOnlinePageType.FLOW:e.id!==f.SysOnlineFormType.REPORT)),I=(0,u.EW)(()=>w.value.datasourceTableList.filter(e=>{switch(h.value.formType){case f.SysOnlineFormType.FLOW:case f.SysOnlineFormType.WORK_ORDER:return null==e.relationType;case f.SysOnlineFormType.FORM:return w.value.pageType===c.SysOnlinePageType.FLOW?e.relationType===c.SysOnlineRelationType.ONE_TO_MANY:null==e.relationType||e.relationType===c.SysOnlineRelationType.ONE_TO_MANY;case f.SysOnlineFormType.QUERY:case f.SysOnlineFormType.ADVANCE_QUERY:case f.SysOnlineFormType.GROUP_QUERY:return null==e.relationType||e.relationType===c.SysOnlineRelationType.ONE_TO_MANY;case f.SysOnlineFormType.ONE_TO_ONE_QUERY:return e.relationType===c.SysOnlineRelationType.ONE_TO_ONE;default:return!1}})),w=(0,u.EW)(()=>({pageId:l.pageId||_.value.pageId,pageType:l.pageType||_.value.pageType,datasourceTableList:l.datasourceTableList||_.value.datasourceTableList,datasourceId:l.datasourceId||_.value.datasourceId,form:l.form||_.value.form})),W=(0,u.EW)(()=>null!=w.value.form),P=()=>{l.dialog?l.dialog.cancel():R(!1)},L=()=>{let e={onlineFormDto:{...h.value,pageId:w.value.pageId,widgetJson:W.value?h.value.widgetJson:JSON.stringify(S(h.value.formType,l.pageType)),paramsJson:W.value?h.value.paramsJson:JSON.stringify([]),datasourceIdList:[w.value.datasourceId]}},a=W.value?T.k$.update(e):T.k$.add(e);a.then(e=>{g.nk.success("保存成功"),l.dialog?l.dialog.submit(e):R(!0)}).catch(e=>{console.warn(e)})},C=e=>{if(null==e)return"success";switch(e){case c.SysOnlineRelationType.ONE_TO_ONE:return"";case c.SysOnlineRelationType.ONE_TO_MANY:return"warning";default:return"info"}},V=e=>null==e?"数据主表":c.SysOnlineRelationType.getValue(e)||"未知类型",U=e=>{w.value.pageType===c.SysOnlinePageType.FLOW&&(h.value.formKind=e===f.SysOnlineFormType.FORM?c.SysOnlineFormKind.DIALOG:c.SysOnlineFormKind.PAGE)};return(0,u.sV)(()=>{W.value?h.value={...w.value.form}:h.value.formType=w.value.pageType===c.SysOnlinePageType.FLOW?f.SysOnlineFormType.FLOW:f.SysOnlineFormType.QUERY}),(e,a)=>{const l=d.WK,g=r.xE,c=i.uD,f=s.P9,T=s.AV,O=t.u,b=o.S2,v=r.US,S=n.S2;return(0,u.uX)(),(0,u.CE)("div",F,[(0,u.bF)(v,{ref:"form",model:(0,p.R1)(h),class:"full-width-input form-box",rules:E,style:{width:"100%"},"label-width":"100px",size:(0,p.R1)(k),"label-position":"right",onSubmit:a[4]||(a[4]=(0,y.D$)(()=>{},["prevent"]))},{default:(0,u.k6)(()=>[(0,u.bF)(b,{gutter:20},{default:(0,u.k6)(()=>[(0,u.bF)(c,{span:24},{default:(0,u.k6)(()=>[(0,u.bF)(g,{label:"表单编码",prop:"formCode"},{default:(0,u.k6)(()=>[(0,u.bF)(l,{class:"input-item",modelValue:(0,p.R1)(h).formCode,"onUpdate:modelValue":a[0]||(a[0]=e=>(0,p.R1)(h).formCode=e),clearable:!0,placeholder:"表单编码"},null,8,["modelValue"])]),_:1})]),_:1}),(0,u.bF)(c,{span:24},{default:(0,u.k6)(()=>[(0,u.bF)(g,{label:"表单名称",prop:"formName"},{default:(0,u.k6)(()=>[(0,u.bF)(l,{class:"input-item",modelValue:(0,p.R1)(h).formName,"onUpdate:modelValue":a[1]||(a[1]=e=>(0,p.R1)(h).formName=e),clearable:!0,placeholder:"表单名称"},null,8,["modelValue"])]),_:1})]),_:1}),(0,u.bF)(c,{span:24},{default:(0,u.k6)(()=>[(0,u.bF)(g,{label:"表单类型",prop:"formType"},{default:(0,u.k6)(()=>[(0,u.bF)(T,{class:"input-item",modelValue:(0,p.R1)(h).formType,"onUpdate:modelValue":a[2]||(a[2]=e=>(0,p.R1)(h).formType=e),placeholder:"表单类型",disabled:(0,p.R1)(W),onChange:U},{default:(0,u.k6)(()=>[((0,u.uX)(!0),(0,u.CE)(u.FK,null,(0,u.pI)((0,p.R1)(N),e=>((0,u.uX)(),(0,u.Wv)(f,{key:e.id,value:e.id,label:e.name},null,8,["value","label"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1})]),_:1}),(0,u.bF)(c,{span:24},{default:(0,u.k6)(()=>[(0,u.bF)(g,{label:"表单数据",prop:"masterTableId"},{default:(0,u.k6)(()=>[(0,u.bF)(T,{class:"input-item",modelValue:(0,p.R1)(h).masterTableId,"onUpdate:modelValue":a[3]||(a[3]=e=>(0,p.R1)(h).masterTableId=e),clearable:!0,placeholder:"表单数据",disabled:(0,p.R1)(W)},{default:(0,u.k6)(()=>[((0,u.uX)(!0),(0,u.CE)(u.FK,null,(0,u.pI)((0,p.R1)(I),e=>((0,u.uX)(),(0,u.Wv)(f,{key:e.tableId,value:e.tableId,label:e.tableName},{default:(0,u.k6)(()=>[(0,u.bF)(b,{type:"flex",justify:"space-between",align:"middle"},{default:(0,u.k6)(()=>[(0,u.Lk)("span",null,(0,m.v_)(e.tableName),1),(0,u.bF)(O,{size:(0,p.R1)(k),type:C(e.relationType),effect:"dark",style:{"margin-left":"30px"}},{default:(0,u.k6)(()=>[(0,u.eW)((0,m.v_)(V(e.relationType)),1)]),_:2},1032,["size","type"])]),_:2},1024)]),_:2},1032,["value","label"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1})]),_:1})]),_:1})]),_:1},8,["model","size"]),(0,u.bF)(b,{class:"menu-box"},{default:(0,u.k6)(()=>[(0,u.bF)(c,{span:24},{default:(0,u.k6)(()=>[(0,u.bF)(b,{class:"no-scroll flex-box",type:"flex",justify:"end"},{default:(0,u.k6)(()=>[(0,u.bF)(S,{size:(0,p.R1)(k),plain:!0,onClick:P},{default:(0,u.k6)(()=>a[6]||(a[6]=[(0,u.eW)(" 取消 ")])),_:1,__:[6]},8,["size"]),(0,u.bF)(S,{type:"primary",size:(0,p.R1)(k),onClick:a[5]||(a[5]=e=>L())},{default:(0,u.k6)(()=>a[7]||(a[7]=[(0,u.eW)(" 保存 ")])),_:1,__:[7]},8,["size"])]),_:1})]),_:1})]),_:1})])}}});const _=S;var R=_},71066:function(e,a,l){l.d(a,{P:function(){return s},i:function(){return i}});var n=l(81387),r=l(27007),o=l(56768),t=l(90144);const s=e=>{console.log("接收到的第三方参数",e);const a=(0,t.KR)(0),l=(0,o.EW)(()=>{let a={};try{e.thirdParamsString&&(a=JSON.parse(e.thirdParamsString))}catch(l){console.log(l),a={}}return a});console.log("thirdParams",l);const n=(n,r,o)=>{console.log("onCloseThirdDialog",r,o),window.parent&&window.parent.postMessage({type:"closeDialog",data:{index:a.value,dialogKey:e.dialogKey,path:l.value.path,rowData:r?JSON.parse(JSON.stringify(r)):void 0,data:o?JSON.parse(JSON.stringify(o)):void 0,isSuccess:n}},"*")},s=(e,l)=>{switch(e){case"setToken":l.token&&(0,r.WG)(l.token);break;case"dialogIndex":a.value=l;break;case"refreshData":break;case"message":break}},i=e=>{s(e.data.type,e.data.data)};return(0,o.sV)(()=>{console.log("onMounted message"),window.addEventListener("message",i,!1)}),(0,o.hi)(()=>{console.log("onUnmounted message"),window.removeEventListener("message",i)}),{thirdParams:l,onCloseThirdDialog:n}},i=()=>{let e;const a=(0,n.lq)(),l=()=>{window.parent&&window.parent.postMessage({type:"refreshToken"},"*")};-1!==a.path.indexOf("/thirdParty/")&&((0,o.sV)(()=>{(0,r.R7)()&&(e=setInterval(()=>{console.log("refreshToken thirdParty"),l()},18e4))}),(0,o.hi)(()=>{e&&clearInterval(e)}))}}}]);
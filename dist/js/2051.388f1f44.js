"use strict";(self["webpackChunkorange"]=self["webpackChunkorange"]||[]).push([[2051],{28181:function(e,a,t){t.d(a,{A:function(){return H}});var l=t(65451),n=(t(97042),t(63390),t(69080)),i=(t(25374),t(21929)),o=(t(98421),t(14022)),r=(t(72343),t(72382)),s=t(76408),d=(t(87535),t(32465),t(85415)),u=(t(22243),t(7409),t(44114),t(18111),t(22489),t(61701),t(56768)),c=t(24232),m=t(90144),f=t(45130),p=t(164),g=t(26695),h=t(81387),v=t(70944),y=t(692),w=t(12687),I=(t(31112),t(25136)),k=(t(69957),t(7588),t(61473)),D=t(89813),b=t(57477),T=t(99540),O=t(36525),R=t(27007),E=t(21016),C=t(42933),W=t(89277),F=t(31932),A=t(18384),N=t(82572),_=t(22414),S=t(43393),L=t(36947);const x={key:1};var K=(0,u.pM)({__name:"OnlineCustomWorkFlowTable",props:{widget:{},dataList:{default:()=>[]},height:{default:"auto"},border:{default:"full"},rowEdit:{type:Boolean,default:!1},multiSelect:{type:Boolean,default:!1},operationList:{default:()=>[]},getTableIndex:{},sortChange:{},onSelectChange:{},onRadioChange:{},processDefinitionKey:{}},emits:["viewWorkOrder","handlerWorkOrder","handlerRemind","cancelWorkOrder","startFlow","refresh"],setup(e,{emit:a}){const t=(0,N.l5)(),l=a,n=e,i=(0,u.WQ)("form",()=>(console.error("OnlineCustomWorkFlowTable: form not injected"),{isEdit:!1})),{downloadFile:o}=(0,W.m)(),{parseUploadData:r}=(0,F.v)(),s=(0,m.KR)(),d=(0,m.KR)(),p=(0,m.KR)(),g=(0,m.KR)({workOrderCode:{showName:"工单编号",show:!0},"runtimeTaskInfo.taskName":{showName:"当前任务",show:!0},createTime:{showName:"创建时间",show:!0},"latestApprovalStatusDictMap.name":{showName:"审批状态",show:!0},flowStatusShowName:{showName:"流程状态",show:!0}}),h=(0,u.EW)(()=>{let e=n.widget&&n.widget.props&&Array.isArray(n.widget.props.tableColumnList)?n.widget.props.tableColumnList:[];return e=e.map(e=>({...e})),e.forEach(e=>{0===e.fieldType||null==e.fieldType?(e.showFieldName="masterData."+(e.relation?e.relation.variableName:"")+(e.column||{}).columnName,(e.column||{}).dictInfo&&(e.showFieldName=e.showFieldName+"DictMap.name")):e.showFieldName=e.customFieldName}),e}),K=(0,u.EW)(()=>h.value.filter(e=>e.column&&e.column.fieldKind===O.SysOnlineFieldKind.UPLOAD_IMAGE).length>0),M=(0,u.EW)(()=>K.value?80:35),V=(0,u.EW)(()=>(n.widget||{}).variableName+(new Date).getTime()+h.value.length),z=(0,u.EW)(()=>!1),P=(0,u.EW)(()=>{let e=(0,R.PH)(n.widget.operationList,E.SysCustomWidgetOperationType.PRINT,"type");return e&&e.enabled?e:null}),B=(0,u.EW)(()=>{let e={},a=i().flowData;return a&&(a.processDefinitionKey&&(e.processDefinitionKey=a.processDefinitionKey),a.processInstanceId&&(e.processInstanceId=a.processInstanceId),a.taskId&&(e.taskId=a.taskId)),e}),Y=(0,u.EW)(()=>i().customConfig),X=(0,u.EW)(()=>p.value&&p.value.extraData?p.value.extraData[n.widget.variableName]:void 0),q=(0,u.EW)(()=>{let e=U.value.map(e=>({columnId:e.columnId,show:e.show,showName:e.showName}));return Object.keys(g.value).forEach(a=>{null!=g.value[a]&&e.push({columnId:a,show:g.value[a].show,showName:g.value[a].showName})}),{tableColumnList:e}}),U=(0,u.EW)(()=>{let e=[];const a=X.value;return(h.value||[]).forEach(t=>{a&&a.tableColumnConfig&&a.tableColumnConfig[t.columnId]?e.push({...t,...a.tableColumnConfig[t.columnId]}):(t.needRender=null!=(t.eventInfo||{})[E.OnlineFormEventType.CELL_RENDER],e.push({...t,show:!0}))}),e}),j=(0,u.EW)(()=>U.value.filter(e=>e.show)),Q=()=>{l("refresh")},H=()=>{l("startFlow")},G=e=>null!=g.value[e]&&g.value[e].show,$=e=>{null==p.value&&(p.value={id:void 0,onlineFormId:i().rawData.onlineForm.formId,extraData:{}}),null==p.value.extraData&&(p.value.extraData={}),null==p.value.extraData[n.widget.variableName]&&(p.value.extraData[n.widget.variableName]={}),p.value.extraData[n.widget.variableName].tableColumnConfig=e,p.value={...p.value},Object.keys(g.value).forEach(a=>{null!=e[a]&&(g.value[a].show=e[a].show)});const a=i().rawData.onlineForm.formId;L.k$.saveFormUserExt({id:(p.value||{}).id,onlineFormId:a,extraData:JSON.stringify(p.value.extraData)},void 0,{showMask:!1}).then(e=>{p.value.id=e.data}).catch(e=>{console.log(e)})},J=e=>n.getTableIndex?n.getTableIndex(e.seq-1):e.seq,Z=e=>{if(!n.widget.props.paged)return;let a=e.property.replace("DictMap.name",""),t=e.order;null==t&&(a=void 0),"asc"===t&&(t="ascending"),null!=d.value&&d.value.prop===a&&d.value.order===t||(d.value={prop:a,order:t},n.sortChange&&n.sortChange(d.value))},ee=e=>{l("viewWorkOrder",e,C.A.getWidgetAttribute(n.widget.widgetType))},ae=e=>{l("handlerWorkOrder",e,C.A.getWidgetAttribute(n.widget.widgetType))},te=e=>{l("handlerRemind",e,C.A.getWidgetAttribute(n.widget.widgetType))},le=e=>{l("cancelWorkOrder",e,C.A.getWidgetAttribute(n.widget.widgetType))},ne=e=>{let a=null;return a=null!=i().flowData?A.x+"/flow/flowOnlineOperation/download":e.relationId?A.x+"/online/onlineOperation/downloadOneToManyRelation/"+(n.widget.datasource||{}).variableName:A.x+"/online/onlineOperation/downloadDatasource/"+(n.widget.datasource||{}).variableName,a},ie=(e,a)=>{let t=(0,R.nh)(a,e.showFieldName);if(null==t)return[];let l={...B.value,datasourceId:n.widget.datasource.datasourceId,relationId:e.relationId,fieldName:e.column.columnName,asImage:e.column.fieldKind===O.SysOnlineFieldKind.UPLOAD_IMAGE,dataId:a.businessKey},i=ne(e),o=JSON.parse(t.toString());return o=Array.isArray(o)?o.map(e=>({...e,downloadUri:i})):[],r(JSON.stringify(o),l)},oe=(e,a)=>{let t;return Array.isArray(a)&&(t=a.map(a=>{let t=a.paramValue;if(null!=t){let l,n=i().columnMap.get(t);if(l=null==n?e[a.paramValue]:(e.masterData||{})[n.columnName],null!=a.paramName&&null!=l)return{paramName:a.paramName,paramValue:l}}return null}).filter(e=>null!=e)),t},re=(e,a)=>{if(null==e||null==a||null==a.processDefinitionKey)return;let t,l=oe(a,e.printParamList);t=Array.isArray(l)?l:[];let n=i().formName+(1===e.printTemplateType?".docx":".xlsx");(0,S.Lv)(e.printTemplateId,e.printTemplateType,t,n)},se=e=>{null!=e&&Object.keys(e).forEach(a=>{let t=e[a];if("object"===typeof t&&-1===a.indexOf("DictMap"))se(t);else if(-1!==a.indexOf("DictMapList")&&Array.isArray(e[a])){let t=a.replace("DictMapList","DictMap");e[t]={id:e[a.replace("DictMapList","")],name:e[a].map(e=>e.name).join(", ")}}})},de=(e,a)=>e&&e.eventInfo[E.OnlineFormEventType.CELL_RENDER]?e.eventInfo[E.OnlineFormEventType.CELL_RENDER](a,i().instanceData(),u.h,D):(0,R.nh)(a,e.showFieldName);return(0,u.wB)(()=>n.dataList,e=>{e&&e.forEach(e=>{se(e.masterData)})},{immediate:!0}),(0,u.wB)(()=>Y.value,()=>{if(null!=Y.value&&(p.value=Y.value,p.value&&p.value.extraData)){let e=p.value.extraData[n.widget.variableName];e&&e.tableColumnConfig&&Object.keys(g.value).forEach(a=>{null!=e.tableColumnConfig[a]&&(g.value[a].show=e.tableColumnConfig[a].show)})}},{deep:!0,immediate:!0}),(e,a)=>{const l=I.S2,n=w.u,i=y.A,o=v.A;return(0,u.uX)(),(0,u.Wv)(o,{ref_key:"table",ref:s,key:(0,m.R1)(V),data:e.dataList,height:e.height,"header-cell-class-name":"table-header-gray",style:{height:"100%"},"keep-source":!1,"row-config":{height:(0,m.R1)(M),isHover:!0},"seq-config":{seqMethod:J},"sort-config":{remote:(0,m.R1)(z)},customConfig:(0,m.R1)(q),supportTableConfig:!0,onRefresh:a[1]||(a[1]=e=>Q()),onSortChange:Z,onTableConfig:$},{operator:(0,u.k6)(()=>[(0,u.bF)(l,{type:"primary",icon:(0,m.R1)(b.Plus),size:(0,m.R1)(t).defaultFormItemSize,disabled:null==e.processDefinitionKey,onClick:a[0]||(a[0]=e=>H())},{default:(0,u.k6)(()=>a[2]||(a[2]=[(0,u.eW)(" 新建 ")])),_:1,__:[2]},8,["icon","size","disabled"])]),empty:(0,u.k6)(()=>a[7]||(a[7]=[(0,u.Lk)("div",{class:"table-empty unified-font"},[(0,u.Lk)("img",{src:k}),(0,u.Lk)("span",null,"暂无数据")],-1)])),default:(0,u.k6)(()=>[(0,m.R1)(h).length>0?((0,u.uX)(),(0,u.Wv)((0,m.R1)(T.Wq),{key:0,type:"seq",title:"序号",width:60})):(0,u.Q3)("",!0),G("workOrderCode")&&!e.widget.props.hideOrderCode?((0,u.uX)(),(0,u.Wv)((0,m.R1)(T.Wq),{key:1,title:"工单编号","show-overflow":"tooltip",field:"workOrderCode",width:200})):(0,u.Q3)("",!0),((0,u.uX)(!0),(0,u.CE)(u.FK,null,(0,u.pI)((0,m.R1)(j),e=>((0,u.uX)(),(0,u.CE)(u.FK,null,[e.column&&"Boolean"===e.column.objectFieldType?((0,u.uX)(),(0,u.Wv)((0,m.R1)(T.Wq),{key:e.columnId,title:e.showName,width:e.columnWidth},{default:(0,u.k6)(({row:a})=>[(0,u.bF)(n,{size:(0,m.R1)(t).defaultFormItemSize,type:(0,m.R1)(R.nh)(a,e.showFieldName)?"success":"danger"},{default:(0,u.k6)(()=>[(0,u.eW)((0,c.v_)((0,m.R1)(R.nh)(a,e.showFieldName)?"是":"否"),1)]),_:2},1032,["size","type"])]),_:2},1032,["title","width"])):e.column&&null!=e.column.fieldKind&&e.column.fieldKind===(0,m.R1)(O.SysOnlineFieldKind).UPLOAD_IMAGE?((0,u.uX)(),(0,u.Wv)((0,m.R1)(T.Wq),{key:e.columnId+"_image",title:e.showName,width:e.columnWidth},{default:(0,u.k6)(({row:a})=>[(0,u.bF)(i,{"file-list":ie(e,a),type:"card",direction:"horizontal",readonly:!0},null,8,["file-list"])]),_:2},1032,["title","width"])):e.column&&null!=e.column.fieldKind&&e.column.fieldKind===(0,m.R1)(O.SysOnlineFieldKind).UPLOAD?((0,u.uX)(),(0,u.Wv)((0,m.R1)(T.Wq),{key:e.columnId+"_file",title:e.showName,width:e.columnWidth},{default:(0,u.k6)(({row:a})=>[(0,u.bF)(i,{"file-list":ie(e,a),type:"text",direction:"horizontal",readonly:!0},null,8,["file-list"])]),_:2},1032,["title","width"])):((0,u.uX)(),(0,u.Wv)((0,m.R1)(T.Wq),{key:e.columnId+"_other",title:e.showName,field:e.showFieldName,width:e.columnWidth,sortable:e.sortable,"show-overflow":void 0!=e.textShowType&&0!==e.textShowType?"title":""},{default:(0,u.k6)(({row:a})=>[e.needRender?((0,u.uX)(),(0,u.Wv)((0,u.$y)(()=>de(e,a)),{key:0})):((0,u.uX)(),(0,u.CE)("span",x,(0,c.v_)((0,m.R1)(R.nh)(a,e.showFieldName)),1))]),_:2},1032,["title","field","width","sortable","show-overflow"]))],64))),256)),G("runtimeTaskInfo.taskName")?((0,u.uX)(),(0,u.Wv)((0,m.R1)(T.Wq),{key:2,title:"当前任务",field:"runtimeTaskInfo.taskName","min-width":100})):(0,u.Q3)("",!0),G("createTime")?((0,u.uX)(),(0,u.Wv)((0,m.R1)(T.Wq),{key:3,title:"创建时间",field:"createTime","min-width":180})):(0,u.Q3)("",!0),G("latestApprovalStatusDictMap.name")?((0,u.uX)(),(0,u.Wv)((0,m.R1)(T.Wq),{key:4,title:"审批状态",field:"latestApprovalStatusDictMap.name","min-width":100})):(0,u.Q3)("",!0),G("flowStatusShowName")?((0,u.uX)(),(0,u.Wv)((0,m.R1)(T.Wq),{key:5,title:"流程状态",field:"flowStatusShowName","min-width":100})):(0,u.Q3)("",!0),(0,u.bF)((0,m.R1)(T.Wq),{title:"操作",width:e.widget.props.operationColumnWidth||180,fixed:"right","show-overflow":!1},{default:(0,u.k6)(({row:e})=>[null!=(0,m.R1)(P)?((0,u.uX)(),(0,u.Wv)(l,{key:0,link:"",type:"primary",size:(0,m.R1)(t).defaultFormItemSize,class:(0,c.C4)((0,m.R1)(P).btnClass),onClick:(0,f.D$)(a=>re((0,m.R1)(P),e),["stop"])},{default:(0,u.k6)(()=>[(0,u.eW)((0,c.v_)((0,m.R1)(P).name||"打印"),1)]),_:2},1032,["size","class","onClick"])):(0,u.Q3)("",!0),(e.initTaskInfo||{}).taskKey!==(e.runtimeTaskInfo||{}).taskKey?((0,u.uX)(),(0,u.Wv)(l,{key:1,type:"primary",link:"",size:(0,m.R1)(t).defaultFormItemSize,onClick:(0,f.D$)(a=>ee(e),["stop"])},{default:(0,u.k6)(()=>a[3]||(a[3]=[(0,u.eW)(" 详情 ")])),_:2,__:[3]},1032,["size","onClick"])):(0,u.Q3)("",!0),(e.initTaskInfo||{}).taskKey===(e.runtimeTaskInfo||{}).taskKey?((0,u.uX)(),(0,u.Wv)(l,{key:2,type:"primary",link:"",size:(0,m.R1)(t).defaultFormItemSize,onClick:(0,f.D$)(a=>ae(e),["stop"])},{default:(0,u.k6)(()=>a[4]||(a[4]=[(0,u.eW)(" 办理 ")])),_:2,__:[4]},1032,["size","onClick"])):(0,u.Q3)("",!0),(0,u.bF)(l,{link:"",type:"primary",size:(0,m.R1)(t).defaultFormItemSize,disabled:e.flowStatus===(0,m.R1)(_.SysFlowWorkOrderStatus).CANCEL,onClick:(0,f.D$)(a=>te(e),["stop"])},{default:(0,u.k6)(()=>a[5]||(a[5]=[(0,u.eW)(" 催办 ")])),_:2,__:[5]},1032,["size","disabled","onClick"]),(0,u.bF)(l,{link:"",type:"primary",size:(0,m.R1)(t).defaultFormItemSize,disabled:e.flowStatus===(0,m.R1)(_.SysFlowWorkOrderStatus).CANCEL,onClick:(0,f.D$)(a=>le(e),["stop"])},{default:(0,u.k6)(()=>a[6]||(a[6]=[(0,u.eW)(" 撤销 ")])),_:2,__:[6]},1032,["size","disabled","onClick"])]),_:1},8,["width"])]),_:1},8,["data","height","row-config","seq-config","sort-config","customConfig"])}}});const M=K;var V=M,z=t(60265),P=t(61617),B=t(11051),Y=t(46954),X=t(69838);const q={class:"online-query-form"};var U=(0,u.pM)({__name:"index",props:{entryId:{},formConfig:{},height:{},masterTableData:{},isEdit:{type:Boolean,default:!1},currentWidget:{},mode:{}},emits:["widgetClick","tableClick"],setup(e,{emit:a}){const t=a,v=(0,h.rd)(),y=e,w=(0,N.l5)(),{getDictDataList:I}=(0,Y.o)(),{isReady:k,dialogParams:D,form:b,formData:T,getWidgetValue:R,getWidgetProp:W,getWidgetVisible:F,onValueChange:A,onWidgetValueChange:S,getDropdownParams:L,checkOperationPermCode:x,checkOperationDisabled:K,checkOperationVisible:M,cloneWidget:U,handlerOperation:j,loadOnlineFormConfig:Q,getIgnoreMaskFields:H,onPrint:G,initPage:$,initFormWidgetList:J,initWidgetLinkage:Z,loadOnlineDictList:ee,showDialog:ae,showOnlineDialog:te,instanceData:le}=(0,B.m)({props:y,router:v});(0,u.Gt)("form",()=>({...b.value,mode:y.mode||"pc",isEdit:D.value.isEdit,checkOperationPermCode:x,checkOperationDisabled:K,checkOperationVisible:M,getWidgetValue:R,getWidgetProp:W,getWidgetVisible:F,onValueChange:A,onWidgetValueChange:S,getDropdownParams:L,cloneWidget:U,handlerOperation:j,getDictDataList:I,loadOnlineDictList:ee,loadOnlineFormConfig:Q,isActive:e=>y.currentWidget===e,getWidgetObject:C.A.getWidgetObject,instanceData:()=>le}));const ne=(0,m.KR)(),ie=(0,m.KR)(),oe=(0,m.Kh)({createTime:[],workOrderCode:void 0,flowStatus:void 0}),re=(0,u.EW)(()=>b.value.widgetList),se=(0,u.EW)(()=>b.value.tableWidget),de=e=>{t("widgetClick",e)},ue=e=>{re.value.push(e)},ce=e=>{p.s.confirm("是否删除此组件？","",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{let a=b.value.widgetList.indexOf(e);-1!==a&&b.value.widgetList.splice(a,1),de(null)}).catch(e=>{console.warn(e)})},me=()=>Array.isArray(re.value)?re.value.map(e=>{if(e.bindData.dataType!==E.SysCustomWidgetBindDataType.Column||null==e.column)return null;let a=e.column,t=R(e);if(null==t||""===t||Array.isArray(t)&&0===t.length)return null;let l={tableName:e.table.tableName,columnName:e.column.columnName,filterType:e.column.filterType,columnValue:e.column.filterType!==O.SysOnlineColumnFilterType.RANFGE_FILTER?t:void 0};return a.filterType===O.SysOnlineColumnFilterType.RANFGE_FILTER&&(l.columnValueStart=t[0],l.columnValueEnd=t[1]),l}).filter(e=>null!=e):[],fe=async e=>{if(e={...e,filterDtoList:me(),flowWorkOrderDtoFilter:{flowStatus:oe.flowStatus,workOrderCode:oe.workOrderCode,createTimeStart:Array.isArray(oe.createTime)?oe.createTime[0]:void 0,createTimeEnd:Array.isArray(oe.createTime)?oe.createTime[1]:void 0}},e.ignoreMaskFields=H(),!Array.isArray(e.orderParam)||e.orderParam.length<=0){let{orderColumn:a,orderAsc:t}=se.value.props;a&&(e.orderParam=[{fieldName:a,asc:!!t}])}if(y.isEdit||"function"!==typeof se.value.eventInfo[E.OnlineFormEventType.BEFORE_LOAD_TABLE_DATA]||(e=await se.value.eventInfo[E.OnlineFormEventType.BEFORE_LOAD_TABLE_DATA](e,le)),null==e)throw new Error;let a=await P.wI.listWorkOrder(e,{processDefinitionKey:ne.value});return a.data.dataList=a.data.dataList.map(e=>{let a=null==e.initTaskInfo?{}:JSON.parse(e.initTaskInfo),t=Array.isArray(e.runtimeTaskInfoList)&&e.runtimeTaskInfoList.length>0?e.runtimeTaskInfoList[0]:{};return{...e,flowStatusShowName:_.SysFlowWorkOrderStatus.getValue(e.flowStatus),initTaskInfo:a,runtimeTaskInfo:t}}),y.isEdit||"function"!==typeof se.value.eventInfo[E.OnlineFormEventType.AFTER_LOAD_TABLE_DATA]||(a.data.dataList=await se.value.eventInfo[E.OnlineFormEventType.AFTER_LOAD_TABLE_DATA](a.data.dataList,le)),{dataList:a.data.dataList,totalCount:a.data.totalCount}},pe=()=>!0,ge={loadTableData:fe,verifyTableParameter:pe,paged:y.formConfig.tableWidget.props.paged},he=(0,m.Kh)((0,z.K)(ge)),ve=()=>{t("tableClick",se.value)},ye=()=>{if(y.isEdit||null==ne.value)return;let e={processDefinitionKey:ne.value};P.wI.viewInitialTaskInfo(e).then(e=>{e.data&&e.data.taskType===_.SysFlowTaskType.USER_TASK&&e.data.assignedMe?v.push({name:e.data.routerName||"handlerFlowTask",query:{processDefinitionKey:ne.value,formId:e.data.formId,routerName:e.data.routerName,readOnly:e.data.readOnly,taskName:"启动流程",taskKey:e.data.taskKey,isDraft:"true",flowEntryName:ie.value,operationList:JSON.stringify((e.data.operationList||[]).filter(e=>e.type!==_.SysFlowTaskOperationType.CO_SIGN&&e.type!==_.SysFlowTaskOperationType.REVOKE&&e.type!==_.SysFlowTaskOperationType.SIGN_REDUCTION)),variableList:JSON.stringify(e.data.variableList)}}):P.wI.startOnly({processDefinitionKey:ne.value}).then(()=>{g.nk.success("启动成功！")}).catch(e=>{console.warn(e)})}).catch(e=>{console.warn(e)})},we=e=>{if(y.isEdit||null==ne.value)return;let a=Array.isArray(e.runtimeTaskInfoList)&&e.runtimeTaskInfoList.length>0?e.runtimeTaskInfoList[0].taskId:void 0,t={processInstanceId:e.processInstanceId,processDefinitionId:e.processDefinitionId,taskId:a};P.wI.viewRuntimeTaskInfo(t).then(t=>{t.data&&v.push({name:t.data.routerName||"handlerFlowTask",query:{isRuntime:"true",isDraft:e.flowStatus===_.SysFlowWorkOrderStatus.DRAFT?"true":"false",taskId:a,processDefinitionKey:e.processDefinitionKey,processInstanceId:e.processInstanceId,processDefinitionId:e.processDefinitionId,formId:t.data.formId,routerName:t.data.routerName,readOnly:t.data.readOnly,taskName:(e.runtimeInitialTask||{}).taskName,taskKey:t.data.taskKey,flowEntryName:e.processDefinitionName,processInstanceInitiator:e.processInstanceInitiator,operationList:JSON.stringify((t.data.operationList||[]).filter(e=>e.type!==_.SysFlowTaskOperationType.CO_SIGN)),variableList:JSON.stringify(t.data.variableList)}})}).catch(e=>{console.warn(e)})},Ie=e=>{if(y.isEdit||null==ne.value)return;let a={processInstanceId:e.processInstanceId};P.wI.viewInitialHistoricTaskInfo(a).then(a=>{a.data&&v.push({name:a.data.routerName||"handlerFlowTask",query:{isRuntime:"false",processDefinitionKey:e.processDefinitionKey,processInstanceId:e.processInstanceId,processDefinitionId:e.processDefinitionId,formId:a.data.formId,routerName:a.data.routerName,readOnly:"true",taskId:e.runtimeTaskInfo.taskId,flowEntryName:e.processDefinitionName,processInstanceInitiator:e.processInstanceInitiator}})}).catch(e=>{console.warn(e)})},ke=e=>{P.wI.remindRuntimeTask({workOrderId:e.workOrderId}).then(()=>{g.nk.success("催办成功")}).catch(e=>{console.warn(e)})},De=e=>{p.s.confirm("是否撤销此工单？","",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{let a={workOrderId:e.workOrderId,cancelReason:"主动撤销"};P.wI.cancelWorkOrder(a).then(()=>{g.nk.success("撤销成功！"),Oe()}).catch(e=>{console.warn(e)})}).catch(e=>{console.warn(e)})},be=(e=!1)=>{y.isEdit||(e?he.refreshTable(!0,1):he.refreshTable())},Te=()=>{oe.createTime=[],oe.workOrderCode=void 0,oe.flowStatus=void 0,be(!0)},Oe=()=>{be(!0)};return(0,u.sV)(()=>{k.value=!1,y.isEdit||y.entryId&&P.Dy.viewDict({entryId:y.entryId}).then(e=>{ne.value=e.data.processDefinitionKey,ie.value=e.data.processDefinitionName,be(!0)}).catch(e=>{console.warn(e)}),k.value=!0}),(0,u.n)(()=>{be(!0)}),(e,a)=>{const t=d.P9,p=d.AV,g=i.xE,h=s.uD,v=r.A,y=o.WK,I=i.US,O=n.aQ,R=l.S2;return(0,u.bo)(((0,u.uX)(),(0,u.CE)("div",{class:"online-workflow-order-form",style:(0,c.Tr)({height:e.height?e.height:"100%"})},[(0,u.bF)(I,{class:"query-filter-box",ref:"onlineWorkOrder",model:(0,m.R1)(oe),"label-width":"80px",size:(0,m.R1)(w).defaultFormItemSize,"label-position":"right",onSubmit:a[4]||(a[4]=(0,f.D$)(()=>{},["prevent"]))},{default:(0,u.k6)(()=>[(0,u.bF)(X.A,{class:"query-filter-box",isEdit:(0,m.R1)(D).isEdit,ref:"filterBox",itemWidth:(0,m.R1)(b).filterItemWidth||350,style:(0,c.Tr)({"margin-bottom":(0,m.R1)(D).isEdit?"10px":"0px"}),widgetList:(0,m.R1)(re),formData:(0,m.R1)(T),hasSlot:!0,onWidgetClick:de,onSearch:a[3]||(a[3]=e=>be(!0)),onReset:Te,onCopy:ue,onDelete:ce},{default:(0,u.k6)(()=>[(0,u.bF)(h,{class:"filter",span:6},{default:(0,u.k6)(()=>[(0,u.bF)(g,{label:"流程状态",prop:"flowStatus"},{default:(0,u.k6)(()=>[(0,u.bF)(p,{class:"filter-item",modelValue:(0,m.R1)(oe).flowStatus,"onUpdate:modelValue":a[0]||(a[0]=e=>(0,m.R1)(oe).flowStatus=e),clearable:!0,placeholder:"流程状态"},{default:(0,u.k6)(()=>[((0,u.uX)(!0),(0,u.CE)(u.FK,null,(0,u.pI)((0,m.R1)(_.SysFlowWorkOrderStatus).getList(),e=>((0,u.uX)(),(0,u.Wv)(t,{key:e.id,label:e.name,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1}),(0,u.bF)(h,{class:"filter",span:6},{default:(0,u.k6)(()=>[(0,u.bF)(g,{label:"创建日期",prop:"createTime"},{default:(0,u.k6)(()=>[(0,u.bF)(v,{class:"filter-item",modelValue:(0,m.R1)(oe).createTime,"onUpdate:modelValue":a[1]||(a[1]=e=>(0,m.R1)(oe).createTime=e),clearable:!0,allowTypes:["day"],align:"left","range-separator":"-","start-placeholder":"开始日期","end-placeholder":"结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD HH:mm:ss"},null,8,["modelValue"])]),_:1})]),_:1}),(0,u.bF)(h,{class:"filter",span:6},{default:(0,u.k6)(()=>[(0,u.bF)(g,{label:"工单编号",prop:"workOrderCode"},{default:(0,u.k6)(()=>[(0,u.bF)(y,{class:"filter-item",modelValue:(0,m.R1)(oe).workOrderCode,"onUpdate:modelValue":a[2]||(a[2]=e=>(0,m.R1)(oe).workOrderCode=e),clearable:!0,placeholder:"工单编号"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["isEdit","itemWidth","style","widgetList","formData"])]),_:1},8,["model","size"]),(0,u.Lk)("div",q,[(0,u.Lk)("div",{class:(0,c.C4)(["query-table-box custom-widget-item widget-item",{active:e.isEdit&&e.currentWidget===(0,m.R1)(se)}]),style:(0,c.Tr)({padding:e.isEdit&&e.currentWidget===(0,m.R1)(se)?"2px":"0px"}),onClick:(0,f.D$)(ve,["stop"])},[(0,m.R1)(k)?((0,u.uX)(),(0,u.Wv)(V,{key:0,dataList:(0,m.R1)(he).dataList,isEdit:e.isEdit,widget:(0,m.R1)(se),getTableIndex:(0,m.R1)(he).getTableIndex,sortChange:(0,m.R1)(he).onSortChange,processDefinitionKey:(0,m.R1)(ne),onRefresh:a[5]||(a[5]=e=>be(!0)),onViewWorkOrder:Ie,onHandlerWorkOrder:we,onCancelWorkOrder:De,onHandlerRemind:ke,onStartFlow:a[6]||(a[6]=e=>ye())},null,8,["dataList","isEdit","widget","getTableIndex","sortChange","processDefinitionKey"])):(0,u.Q3)("",!0)],6),(0,m.R1)(se)&&(0,m.R1)(se).props.paged?((0,u.uX)(),(0,u.Wv)(R,{key:0,type:"flex",justify:"end",style:{"margin-top":"16px"}},{default:(0,u.k6)(()=>[(0,u.bF)(O,{total:(0,m.R1)(he).totalCount,"current-page":(0,m.R1)(he).currentPage,"page-size":(0,m.R1)(he).pageSize,"page-sizes":[10,20,50,100],layout:"total, prev, pager, next, sizes",onCurrentChange:(0,m.R1)(he).onCurrentPageChange,onSizeChange:(0,m.R1)(he).onPageSizeChange},null,8,["total","current-page","page-size","onCurrentChange","onSizeChange"])]),_:1})):(0,u.Q3)("",!0)])],4)),[[f.aG,(0,m.R1)(k)]])}}}),j=t(71241);const Q=(0,j.A)(U,[["__scopeId","data-v-667f0ec4"]]);var H=Q},72382:function(e,a,t){t.d(a,{A:function(){return m}});var l=t(88284),n=(t(97042),t(36715),t(85415)),i=(t(22243),t(7409),t(56768)),o=t(90144),r=t(57477);const s={class:"date-range"};var d=(0,i.pM)({__name:"index",props:{modelValue:{default:()=>""},defaultDateType:{default:"day"},size:{default:"default"},hideTypeOnlyOne:{type:Boolean,default:!0},allowTypes:{default:()=>["day","month","year"]},isRange:{type:Boolean,default:!0},editable:{type:Boolean,default:!0},clearable:{type:Boolean,default:!0},align:{default:"left"},rangeSeparator:{default:"-"},format:{default:"YYYY-MM-DD"},valueFormat:{default:"YYYY-MM-DD HH:mm:ss"},prefixIcon:{default:r.Calendar},clearIcon:{default:r.CircleClose},placeholder:{},startPlaceholder:{},endPlaceholder:{},readonly:{type:Boolean},disabled:{type:Boolean}},emits:["update:modelValue","change"],setup(e,{emit:a}){const t=[{value:"day",label:"自然日"},{value:"month",label:"自然月"},{value:"year",label:"自然年"}],r=a,d=e,u=(0,o.KR)(d.defaultDateType),c=(0,i.EW)({get(){return d.modelValue},set(e){r("update:modelValue",e)}}),m=()=>{let e=[];if(null!=c.value&&(d.isRange?Array.isArray(c.value)&&2==c.value.length&&(e[0]=new Date(c.value[0]),e[1]=new Date(c.value[1])):(e[0]=new Date(c.value.toString()),e[1]=new Date(c.value.toString())),null!=e[0]&&null!=e[1])){switch(e[0].setHours(0,0,0,0),e[1].setHours(0,0,0,0),u.value){case"day":e[1].setDate(e[1].getDate()+1);break;case"month":e[1].setDate(1),e[0].setDate(1),e[1].setMonth(e[1].getMonth()+1);break;case"year":e[1].setMonth(0),e[1].setDate(1),e[0].setMonth(0),e[0].setDate(1),e[1].setFullYear(e[1].getFullYear()+1);break}e[1]=new Date(e[1].getTime()-1)}r("update:modelValue",e),r("change",e)},f=(0,i.EW)(()=>t.filter(e=>-1!=d.allowTypes.indexOf(e.value))),p=(0,i.EW)(()=>{switch(u.value){case"day":return d.isRange?"daterange":"date";case"month":return d.isRange?"monthrange":"month";case"year":return d.isRange?"monthrange":"year";default:return d.isRange?"daterange":"date"}}),g=(0,i.EW)(()=>{switch(u.value){case"day":return"YYYY-MM-DD";case"month":return"YYYY-MM";case"year":return"YYYY";default:return"YYYY-MM-DD"}});return(0,i.wB)(u,(e,a)=>{console.log("daterange dateType changed",e,a),-1==d.allowTypes.indexOf(u.value)&&(u.value=d.allowTypes[0]||"day"),m()},{deep:!0,immediate:!0}),(0,i.wB)(()=>d.modelValue,(e,a)=>{console.log("daterange value change",e,a),e!=a&&(c.value=e)},{deep:!0}),(0,i.wB)(()=>d.defaultDateType,(e,a)=>{console.log("daterange defaultDateType changed",e,a),-1!==d.allowTypes.indexOf(e)?u.value=e:u.value=d.allowTypes[0]},{deep:!0,immediate:!0}),(0,i.wB)(()=>d.isRange,(e,a)=>{console.log("daterange isRange changed",e,a),e?c.value&&!Array.isArray(c.value)&&(c.value=[c.value.toString(),c.value.toString()]):Array.isArray(c.value)&&(c.value=c.value[0])},{deep:!0,immediate:!0}),(e,a)=>{const t=n.P9,r=n.AV,d=l.MG;return(0,i.uX)(),(0,i.CE)("div",s,[!e.hideTypeOnlyOne||(0,o.R1)(f).length>1?((0,i.uX)(),(0,i.Wv)(r,{key:0,modelValue:u.value,"onUpdate:modelValue":a[0]||(a[0]=e=>u.value=e),size:e.size,style:{"min-width":"100px","max-width":"100px","margin-right":"10px"}},{default:(0,i.k6)(()=>[((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)((0,o.R1)(f),e=>((0,i.uX)(),(0,i.Wv)(t,{key:e.value,value:e.value,label:e.label},null,8,["value","label"]))),128))]),_:1},8,["modelValue","size"])):(0,i.Q3)("",!0),(0,i.bF)(d,{style:{"flex-grow":"1"},modelValue:(0,o.R1)(c),"onUpdate:modelValue":a[1]||(a[1]=e=>(0,o.i9)(c)?c.value=e:null),size:e.size,placeholder:e.placeholder,type:(0,o.R1)(p),disabled:e.disabled,format:(0,o.R1)(g),readonly:e.readonly,editable:e.editable,clearable:e.clearable,"start-placeholder":e.startPlaceholder,"end-placeholder":e.endPlaceholder,align:e.align,"range-separator":e.rangeSeparator,"value-format":e.valueFormat,"prefix-icon":e.prefixIcon,"clear-icon":e.clearIcon},null,8,["modelValue","size","placeholder","type","disabled","format","readonly","editable","clearable","start-placeholder","end-placeholder","align","range-separator","value-format","prefix-icon","clear-icon"])])}}}),u=t(71241);const c=(0,u.A)(d,[["__scopeId","data-v-284a6fd8"]]);var m=c},77783:function(e,a,t){t.d(a,{A:function(){return b}});var l=t(2403),n=(t(97042),t(63266),t(18111),t(7588),t(61701),t(18237),t(56768)),i=t(24232),o=t(90144),r=t(45130),s=t(27652),d=t(21929),u=t(81387),c=t(89001),m=t(21016),f=t(61617),p=t(36525),g=t(42933),h=t(82572),v=t(46954),y=t(11051);const w={class:"online-work-flow-form",style:{position:"relative",height:"100%","min-height":"200px"}};var I=(0,n.pM)({__name:"index",props:{formConfig:{},height:{},flowInfo:{default:void 0},readOnly:{type:Boolean,default:!1},isEdit:{type:Boolean,default:!1},currentWidget:{},fullscreen:{type:Boolean,default:!1},mode:{default:"pc"}},emits:["widgetClick"],setup(e,{expose:a,emit:t}){const I=(0,u.rd)(),k=(0,h.l5)(),D=t,b=e,T=(0,o.KR)(),{getDictDataList:O}=(0,v.o)(),R=(0,o.KR)(!0),{isReady:E,form:C,rules:W,masterTable:F,formData:A,formAuth:N,richEditWidgetList:_,tableWidgetList:S,getWidgetValue:L,getWidgetVisible:x,onValueChange:K,onWidgetValueChange:M,getPrimaryData:V,getDropdownParams:z,checkOperationPermCode:P,checkOperationDisabled:B,checkOperationVisible:Y,cloneWidget:X,handlerOperation:q,handlerScriptOperation:U,tableInstance:j,loadOnlineFormConfig:Q,getTableData:H,setTableData:G,initPage:$,initFormWidgetList:J,initWidgetRule:Z,initWidgetLinkage:ee,showDialog:ae,showOnlineDialog:te,showSelectDialog:le,instanceData:ne}=(0,y.m)({props:b,router:I,formRef:T});(0,n.Gt)("form",()=>({...C.value,mode:b.mode||"pc",isEdit:b.isEdit,readOnly:R.value||b.readOnly,formData:A,getWidgetValue:L,getWidgetVisible:x,onValueChange:K,onWidgetValueChange:M,getTableData:H,setTableData:G,getPrimaryData:V,getDropdownParams:z,checkOperationPermCode:P,checkOperationDisabled:B,checkOperationVisible:Y,cloneWidget:X,handlerOperation:q,getMasterTableData:()=>A[F.value?.datasource?.variableName],handlerScriptOperation:U,tableInstance:j,showSelectDialog:le,getDictDataList:O,loadOnlineFormConfig:Q,flowData:b.flowInfo,isActive:e=>b.currentWidget===e,getWidgetObject:g.A.getWidgetObject,instanceData:()=>ne,formAuth:()=>N.value}));const ie=e=>{D("widgetClick",e)},oe=(0,n.EW)(()=>!!b.flowInfo&&(b.flowInfo.isDraft||"true"===b.flowInfo.isDraft)),re=async()=>{if(null==b.flowInfo||null==b.flowInfo.processInstanceId)return;let e={processInstanceId:b.flowInfo?.processInstanceId,taskId:b.flowInfo?.taskId,delegateUserId:b.flowInfo?.delegateUserId},a=null;a=oe.value?await f.wI.viewOnlineDraftData({processDefinitionKey:b.flowInfo?.processDefinitionKey,processInstanceId:b.flowInfo?.processInstanceId}):null!=b.flowInfo?.messageId?await f.wI.viewOnlineCopyBusinessData({messageId:b.flowInfo.messageId}):null!=b.flowInfo?.taskId&&b.flowInfo?.isRuntime?await f.wI.viewUserTask(e):await f.wI.viewHistoricProcessInstance(e);let t,l=(a.data||{})[F.value?.datasource?.variableName]||{},n=new Map;C.value.tableMap.forEach(e=>{e.relation?(e.relation.relationType===p.SysOnlineRelationType.ONE_TO_ONE||oe.value?n.set(e.relation.variableName,e.relation):n.set(e.relation.variableName+"List",e.relation),e.relation.relationType===p.SysOnlineRelationType.ONE_TO_ONE?A[e.relation.variableName]=e.columnList.reduce((e,a)=>(e[a.columnName]=void 0,e),{}):A[e.relation.variableName]=[]):null==e.relation&&(t=e.datasource.variableName)}),Object.keys(l).forEach(e=>{let a=n.get(e),i=(a||{}).variableName;null==i?A[t][e]=l[e]:(a.relationType===p.SysOnlineRelationType.ONE_TO_MANY&&l[e]&&Array.isArray(S)&&S.forEach(async t=>{if(t.relation&&t.relation.relationId===a.relationId&&"function"===typeof t.eventInfo[m.OnlineFormEventType.AFTER_LOAD_TABLE_DATA]){l[e]=await t.eventInfo[m.OnlineFormEventType.AFTER_LOAD_TABLE_DATA](l[e],ne)}}),l[e]&&(Array.isArray(l[e])?A[i]=l[e]:A[i]={...A[i],...l[e]}))}),n.clear()},se=()=>{if(null==b.flowInfo||null==b.flowInfo.processDefinitionKey||""===b.flowInfo.processDefinitionKey)return Promise.resolve();let e={processDefinitionKey:b.flowInfo.processDefinitionKey,processInstanceId:b.flowInfo.processInstanceId,taskId:b.flowInfo.taskId};return new Promise((a,t)=>{f.wI.viewTaskFormKey(e).then(e=>{try{let a=JSON.parse(e.data);R.value=null==a.readOnly||a.readOnly,N.value=a.formAuth,Object.keys(N.value||{}).forEach(e=>{let a=N.value[e];Object.keys(a).forEach(e=>{let t=a[e];a[e]=t&&null!=t&&""!==t?t.split(",").map(e=>parseInt(e)):[0,0];let l=1===a[e][0],n=1===a[e][1];a[e].disabled=l,a[e].hide=n})})}catch(t){N.value=null}a()}).catch(e=>{t(e)})})};(0,n.sV)(()=>{E.value=!1,b.isEdit?(E.value=!0,R.value=!1):se().then(()=>{C.value.eventInfo&&"function"===typeof C.value.eventInfo[m.OnlineFormEventType.AFTER_CREATE_FORM]&&C.value.eventInfo[m.OnlineFormEventType.AFTER_CREATE_FORM](ne),Z(),re().then(()=>{C.value.eventInfo&&"function"===typeof C.value.eventInfo[m.OnlineFormEventType.AFTER_LOAD_FORM_DATA]&&C.value.eventInfo[m.OnlineFormEventType.AFTER_LOAD_FORM_DATA](ne),ee(),setTimeout(()=>{T.value&&T.value.clearValidate()})}).catch(e=>{console.warn(e)}),E.value=!0})});const de=async(e=null)=>{let a={formData:A};if(C.value.tableMap.forEach(e=>{e.relation?(null==a.slaveData&&(a.slaveData={}),a.slaveData[e.relation.variableName]=A[e.relation.variableName]):null==e.relation&&(a.masterData=A[e.datasource.variableName])}),e&&e.value&&e.value.forEach(e=>{if(!e.builtin){let t=C.value.columnMap.get(e.bindColumnId),l=C.value.relationMap.get(e.bindRelationId);null!=t&&(null==a.taskVariableData&&(a.taskVariableData={}),a.taskVariableData[e.variableName]=null==l?A[F.value.datasource.variableName][t.columnName]:A[l.variableName][t.columnName])}}),b.isEdit||"function"!==typeof C.value.eventInfo[m.OnlineFormEventType.BEFORE_COMMIT_FORM_DATA]||(a=await C.value.eventInfo[m.OnlineFormEventType.BEFORE_COMMIT_FORM_DATA](a,ne)),null==a)throw new Error;if(a.slaveData){let e=Object.keys(a.slaveData);if(e.length>0){let t=new Map;C.value.tableMap.forEach(e=>{null!=e.relation&&t.set(e.relation.variableName,e.relation.relationId)}),e.forEach(e=>{let l=t.get(e);null!=l&&(a.slaveData[l]=a.slaveData[e]),a.slaveData[e]=void 0})}}return a},ue=(e,a)=>(_&&!R.value&&_.forEach(e=>{e&&e.widgetImpl&&K(e,e.widgetImpl.getHtml())}),new Promise((t,l)=>{e?de().then(e=>{t(e)}).catch(()=>{l()}):(0,n.dY)(()=>{T.value.validate(e=>{e?de(a).then(e=>{t(e)}).catch(e=>{console.log(e),l()}):l()})})}));return a({getFormData:ue}),(e,a)=>{const t=l.kA;return(0,n.uX)(),(0,n.CE)("div",w,[(0,n.Lk)("div",{class:"form-box",style:(0,i.Tr)({"min-height":e.isEdit?e.height:"0px"})},[(0,n.bF)(t,{style:{height:"100%"},class:"custom-scroll"},{default:(0,n.k6)(()=>[((0,n.uX)(),(0,n.Wv)((0,n.$y)("pc"===e.mode?(0,o.R1)(d.US):(0,o.R1)(s.lV)),{ref_key:"componentRef",ref:T,model:(0,o.R1)(A),class:"full-width-input",rules:(0,o.R1)(W),style:{width:"100%"},"label-width":((0,o.R1)(C).labelWidth||100)+"px","label-position":(0,o.R1)(C).labelPosition||"right",size:(0,o.R1)(k).defaultFormItemSize,"show-message":!(0,o.R1)(R),"validate-on-rule-change":!1,onSubmit:a[1]||(a[1]=(0,r.D$)(()=>{},["prevent"]))},{default:(0,n.k6)(()=>[(0,o.R1)(E)?((0,n.uX)(),(0,n.Wv)(c.A,{key:0,ref:"root",value:(0,o.R1)(C).widgetList,"onUpdate:value":a[0]||(a[0]=e=>(0,o.R1)(C).widgetList=e),height:e.height,isEdit:e.isEdit,showBorder:!1,onWidgetClick:ie},null,8,["value","height","isEdit"])):(0,n.Q3)("",!0)]),_:1},40,["model","rules","label-width","label-position","size","show-message"]))]),_:1})],4)])}}}),k=t(71241);const D=(0,k.A)(I,[["__scopeId","data-v-b0c0402a"]]);var b=D}}]);